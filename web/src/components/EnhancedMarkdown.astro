---
import { Code } from "@astrojs/starlight/components";
import { marked } from "marked";
import type { Token } from "marked";

interface Props {
  content?: string;
  inline?: boolean;
}

const { content, inline = false } = Astro.props;

let slotMarkdown = "";
if (!content && Astro.slots.has("default")) {
  slotMarkdown = await Astro.slots.render("default");
}

const rawContent = content ?? slotMarkdown ?? "";

// We shouldn't this as we're now organizing pages in folders
// TODO let's move away from MediaWiki links in the future

function convertMediaWikiLinks(text: string): string {
  const redirects: Record<string, string> = {
    ACL: "acl",
  };

  return text.replace(
    /\[\[([^|\]#]+)(?:#([^\]]+))?(?:\|([^\]]+))?\]\]/g,
    (_, link, hash, text) => {
      const redirected = redirects[link] ?? link;
      const url = `/reference/${redirected}${hash ? `#${hash}` : ""}`;
      return `[${text || link}](${url})`;
    },
  );
}

const processed = convertMediaWikiLinks(rawContent);
const tokens = inline ? marked.Lexer.lexInline(processed) : marked.lexer(processed);
---

{
  (function processTokens(tokens: Token[], isListItem: boolean = false): any[] {
    return tokens.map((token) => {
      if (token.type === "code") {
        return <Code code={token.text} lang={token.lang || "text"} />;
      }

      if (!inline) {
        if (token.type === "list") {
          const listToken = token as any;
          const Tag = listToken.ordered ? "ol" : "ul";

          return (
            <Tag>
              {listToken.items.map((item: Token) => processTokens([item])[0])}
            </Tag>
          );
        }

        if (token.type === "list_item") {
          const listItemToken = token as any;

          if (listItemToken.tokens && listItemToken.tokens.length > 0) {
            const content = processTokens(listItemToken.tokens, true);
            return <li>{content}</li>;
          }

          return <li>{listItemToken.text}</li>;
        }

        if (token.type === "text" && isListItem) {
          const textToken = token as any;
          
          return (
            <Fragment set:html={marked.parseInline(textToken.raw ?? textToken.text ?? "")} />
          );
        }
      }

      if (inline) {
        return (
          <Fragment
            set:html={marked.parseInline(token.raw ?? token.text ?? "")}
          />
        );
      }

      return <Fragment set:html={marked.parser([token])} />;
    });
  })(tokens)
}
